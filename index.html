<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D階層マップ作成ツール</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <!-- Toolbar -->
        <header class="toolbar">
            <div class="brand">3D階層マップ作成</div>
            <button id="add-root-btn" class="btn">新規マップ作成</button>
            <button id="add-independent-btn" class="btn">+ 独立ノード追加</button>
            <!-- Connect Mode moved to sidebar tab -->
            <div class="separator"></div>
            <button id="export-json-btn" class="btn">JSON保存</button>
            <button id="import-json-btn" class="btn">JSON読込</button>
            <input type="file" id="json-file-input" hidden accept=".json">
            <!-- Export Image moved to sidebar tab -->

        </header>

        <!-- Main Workspace -->
        <main class="workspace">
            <div id="canvas-container">
                <canvas id="map-canvas"></canvas>
            </div>

            <!-- Floating Sidebar -->
            <aside class="sidebar">
                <!-- Tab Navigation -->
                <div class="sidebar-tabs">
                    <button class="tab-btn active" data-tab="tab-view">表示</button>
                    <button class="tab-btn" data-tab="tab-props">ノード編集</button>
                    <button class="tab-btn" data-tab="tab-connect">接続線</button>
                    <button class="tab-btn" data-tab="tab-export">書き出し</button>
                </div>

                <!-- Tab Content: View Settings -->
                <div id="tab-view" class="tab-pane active">
                    <div id="view-settings-panel" class="panel-section">
                        <div class="panel-header">
                            <h3>表示設定</h3>
                        </div>
                        <div class="panel-content" id="view-settings-content">
                            <!-- Dynamic Checkboxes -->
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Properties -->
                <div id="tab-props" class="tab-pane">
                    <div id="property-panel" class="panel-section">
                        <div class="panel-header">
                            <h3>プロパティ</h3>
                        </div>
                        <div class="panel-content" id="properties-content">
                            <p class="placeholder-text">ノードを選択すると設定が表示されます。</p>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Connection Line -->
                <div id="tab-connect" class="tab-pane">
                    <div class="panel-section">
                        <div class="panel-header">
                            <h3>接続線ツール</h3>
                        </div>
                        <div class="panel-content" id="connection-content">
                            <div class="form-group">
                                <button id="connect-mode-btn" class="btn" style="width:100%;">接続モード: OFF</button>
                            </div>
                            <hr style="border-color:var(--panel-border); margin-bottom:15px;">
                            <p class="placeholder-text" id="edge-placeholder">線を選択すると設定が表示されます。</p>
                            <div id="edge-settings" style="display:none;">
                                <!-- Edge settings injected here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Export -->
                <div id="tab-export" class="tab-pane">
                    <div class="panel-section">
                        <div class="panel-header">
                            <h3>画像書き出し</h3>
                        </div>
                        <div class="panel-content" style="display: flex; flex-direction: column; gap: 10px;">

                            <!-- Preview / Minimap -->
                            <div style="margin-bottom: 4px;">
                                <label
                                    style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; display: block;">プレビュー
                                    / 範囲選択</label>
                                <div id="export-preview-container" class="preview-container">
                                    <canvas id="minimap-canvas"></canvas>
                                    <div id="crop-overlay">
                                        <div id="crop-box">
                                            <!-- Handles -->
                                            <div class="resize-handle nw" data-handle="nw"></div>
                                            <div class="resize-handle ne" data-handle="ne"></div>
                                            <div class="resize-handle sw" data-handle="sw"></div>
                                            <div class="resize-handle se" data-handle="se"></div>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-top: 6px;">
                                    <button id="crop-reset-btn" class="btn small"
                                        style="font-size: 0.75rem; padding: 4px 8px;">全体を選択</button>
                                    <div style="font-size: 0.75rem; color: #888; align-self: center;"
                                        id="crop-info-text">Select area</div>
                                </div>
                                <p
                                    style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px; line-height: 1.2;">
                                    ※プレビューにはテキスト・グリッドは表示されませんが、書き出し画像には反映されます。
                                </p>
                            </div>

                            <hr style="border-color: var(--panel-border); width: 100%;">

                            <!-- Aspect Ratio Settings -->
                            <div class="form-group" style="margin-bottom: 8px;">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <label style="margin: 0;">アスペクト比 (Aspect Ratio)</label>
                                    <label
                                        style="font-size: 0.8rem; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                        <input type="checkbox" id="crop-aspect-fixed" checked> 固定
                                    </label>
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="number" id="crop-ratio-w" value="16" class="ratio-input">
                                    <span>:</span>
                                    <input type="number" id="crop-ratio-h" value="9" class="ratio-input">
                                </div>
                            </div>

                            <!-- Existing Export Settings -->
                            <div class="form-group" style="margin-bottom: 8px;">
                                <label>倍率 (Scale):</label>
                                <select id="export-scale">
                                    <option value="1">1x</option>
                                    <option value="2" selected>2x</option>
                                    <option value="4">4x</option>
                                </select>
                            </div>

                            <div class="form-group" style="margin-bottom: 8px;">
                                <label>背景色:</label>
                                <div style="display:flex; gap:10px; align-items:center;">
                                    <input type="color" id="export-bg-color" value="#000000">
                                    <label><input type="checkbox" id="export-transparent" checked> 透過</label>
                                </div>
                            </div>

                            <div style="margin-top:auto; padding-top: 10px;">
                                <button id="confirm-export-btn" class="btn primary" style="width:100%;">画像を保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </main>

        <!-- Graph controls helper (Bottom Right) -->
        <div class="graph-controls">
            <button id="duplicate-btn" class="btn secondary" disabled>複製</button>
            <button id="add-child-btn" class="btn secondary" disabled>+ 子ノード追加</button>
            <button id="delete-btn" class="btn danger" disabled>削除</button>
        </div>

        <!-- Export Modal Removed -->
    </div>

    <!-- Scripts (Loaded sequentially to avoid Module CORS issues) -->
    <script src="js/GraphModel.js"></script>
    <script src="js/LayoutEngine.js"></script>
    <script src="js/Renderer.js"></script>
    <script src="js/UIManager.js"></script>
    <script src="js/main.js"></script>
</body>

</html>